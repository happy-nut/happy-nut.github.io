# Kafka Consumer

## Offset

컨슈머는 소비에 성공하는 경우 각 파티션 별로 오프셋을 기록해 두게 되고,
그 다음에 소비를 할 때는 오프셋 이후의 레코드를 가져오게 된다.

커밋의 의미는 안전하게 처리되었다고 마킹하는 것이므로 실패/재시작 상황에서 복구할 오프셋이다.
설정에 따라 자동 커밋을 할 수도 있고, `commitSync` 및 `commitAsync` 메소드를 활용해 수동 커밋을 할 수도 있다.


## Consumer Group

카프카는 컨슈머 그룹을 두어 소비와 처리를 분산한다. 컨슈머 그룹은 그냥 여러 프로세스를 가진 단일 구독자라고 개념적으로 이해해도 무방하다.

예를 들어 파티션이 4개이고, 컨슈머 그룹 안에 컨슈머가 2개 있다면, 각 컨슈머는 2개의 파티션으로부터 데이터를 읽어 처리하게 된다.
만약 파티션이 2개이고 컨슈머 그룹 안에 컨슈머가 4개 있다면, 2개의 컨슈머는 할당된 파티션이 없어 놀게 된다.

컨슈머가 죽거나 새로 추가되어 컨슈머 그룹안에 변동이 생기는 경우 리벨런싱이 일어나게 된다.
또, 새 파티션이 추가/삭제 될 때도 리벨런싱이 일어나게 되는데, 컨슈머 그룹은 주기적인 메타데이터 새로고침을 통해 변경사항을 그룹 구성원에게 
`ConsumerRebalanceListener` 를 통해 알리게 된다. 그러나 실무에서는 수동 조정하는 경우가 많다. 파티션은 한 번 늘리면 줄일 수가 없기 떄문이다.


## Consumer 장애 감지

컨슈머는 지속적으로 `poll` 메소드를 호출하고, 이는 컨슈머로 하려금 살아 있다는 사실을 브로커에 알리는 역할을 한다.




