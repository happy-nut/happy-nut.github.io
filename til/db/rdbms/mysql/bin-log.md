# Mysql bin log

**복제(Replication)**와 **리커버리(Point-in-time Recovery)**를 위해 저장하는 바이너리 로그이다.
DB에서 발생한 모든 변경사항을 기록한다.

## Bin log 확인하기

다음 명령어로 로그 파일 목록을 확인할 수 있다.
```sql
> SHOW BINARY LOGS;
+-------------+---------+---------+
|Log_name     |File_size|Encrypted|
+-------------+---------+---------+
|binlog.000001|1244     |No       |
+-------------+---------+---------+
```

테이블 하나 생성하고 빈로그를 확인해보면 다음과 같다.

```sql
> SHOW BINLOG EVENTS IN 'binlog.000001';
+-------------+----+--------------+---------+-----------+----------------------------------------------------+
|Log_name     |Pos |Event_type    |Server_id|End_log_pos|Info                                                |
+-------------+----+--------------+---------+-----------+----------------------------------------------------+
|binlog.000001|922 |Anonymous_Gtid|1        |1001       |SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                |
|binlog.000001|1001|Query         |1        |1244       |use `local_test`; create table test_table /* 생략 */ |
+-------------+----+--------------+---------+-----------+----------------------------------------------------+
```

Info 에 쿼리문이 들어가 있는 걸 확인해볼 수 있다. pos 를 통해 로그 파일의 커서를 관리하는 것도 함께 확인이 가능하다.

## GTID(Global Transaction Identifier)

위 빈로그를 보면 Gtid 관련 로그가 보이는데, MySQL에서 각 트랜잭션을 전역적으로 고유하게 식별하기 위한 ID이다.
현재는 `SET @@SESSION.GTID_NEXT= 'ANONYMOUS'` 로 찍히는 것으로 보아 비활성화된 상태임을 의미하며, 만약 복제 클러스터 구성을 통해 해당 옵션을 활성화하게 되면
GTID_NEXT 에는 다음에 일어날 트랜잭션의 id가 들어가게 된다.

기존에는 leader db 서버의 pos 를 follower 들이 따라가면서 동기화를 했고 failover 되는 과정에서 문제가 발생하기 쉬웠다면,
GTID 를 활성화하게 되면 Leader 가 바뀌든 말든 트랜재션 Id는 동일하므로 각 서버가 자신의 복제 현황을 독립적으로 알 수 있게 됨으로써 failover 과정에서의 안정성을 높였다. 

기존 방식에서는 follower 가 leader 로 승격되는 과정에서 가장 최신의 트랜잭션 pos 까지 복제 완료되지 않았더라면 일관성 문제가 생길 수 있었던 것이 문제였다.
GTID 방식에서는 전역적으로 고유한 트랜잭션 ID를 사용하기 때문에 승격이 되고 난 후 각 follower 들은 정확한 실행지점을 찾을 수 있게 된 것이다.
 

## PITR(Point-in-time Recovery)

PITR 은 특정 시점으로 DB를 타임머신을 타고 돌아가는 기능인데, 마지막 백업 시점 이후부터의 모든 bin log 를 재생함으로써 특정 시점으로 복구한다.
