# Redis

인 메모리 key value store 이다. 인 메모리라 함은, RAM에다가 key, value 를 적재하여 연산을 수행함을 의미한다.
메인 스레드와 백그라운드 스레드가 함께 동작하며 연산을 처리하는데, 메인 스레드는 싱글 스레드로 동작하기 때문에
메인 스레드 안에서 처리되는 연산들은 thread safe 하다.


## Main thread

메인 스레드가 수행하는 역할은 다음과 같다.
 
- 클라이언트 요청 처리
- 키 값 연산
- 트랜잭션 처리
- 복제 관리

## Background thread

백그라운드 스레드는 메인 스레드와 달리 여러 종류가 만들어져 동작한다.

Lazy free thread
- Unlink 로 제거된 큰 객체들의 메모리 해제

RDB/AOF 스레드
- BGSAVE(RDB 백그라운드 저장)
- AOF 파일 작성

I/O 스레드
- 네트워크 I/O 처리
- 클라이언트 연결 관리

이렇게 여러 백그라운드 스레드가 등장하는 이유는 메인 스레드를 최대한 블로킹하지 않기 위함이다.


## 사용 시 주의사항

Redis 의 메인 스레드는 싱글 스레드이기 때문에, 반복문과 같은 O(n) 연산은 피하거나 불가피할 경우 적어도 n의 크기를 매우 제한하여야 한다.
특히 lua script 를 통해 반복문을 사용하게 되는 경우가 많은데, 버그로 무한루프라도 생기게 되면 해당 redis 노드에 들어가는 모든 연산이 중지된다.

이 때 실행 시간이 기본 설정값(5초)를 넘어간다면 뒤 따라 들어오는 다른 요청들은 대기하지 않고 fast fail 시킨다.
SCRIPT KILL 명령어를 통해 돌고 있는 루아 스크립트를 중단 시킬 수 있지만, WRITE 연산이 한 번이라도 진행되었다면 중단이 불가능하고,
결국 redis 의 모든 메모리를 포기하고 redis 프로세스를 강제 종료한 뒤 노드를 재시작하는 것 외에는 답이 없음.

