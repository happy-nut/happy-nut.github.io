# Redis 의 키 만료 방식

Redis는 키가 만료되었을 때 메모리에서 key, value를 삭제하는데, passive way와 active way 두 가지 방식을 통해 처리한다.

## Passive way

만약 조회하려는 키가 만료되었다면, 해당 키를 메모리에서 제거한다. 이 방식이 Passive way 이다.

## Active way

redis 에서는 초당 10번 주기적으로 만료된 키를 제거하는 훅을 실행하는데,
이 훅은 기본적으로 다음과 같이 동작한다. (Redis 6.0 이전 기준)

1. 전체 키 중 일부를 샘플링하여 만료된 키가 있는지 확인한다.
2. 만료된 키가 있다면 해당 키를 제거한다.
3. 샘플링된 키 중 만료된 키가 일정 비율(25%) 이상이라면, 다시 1번 과정을 반복한다.

이 훅은 100ms 를 초과하지 않도록 제한되므로 무한정 실행되진 않지만 대량의 키 만료가 있을 경우 0.1초마다 100ms 만큼 
병목으로 인한 성능 문제를 야기할 수 있다.

## Redis 6.0 이후에서의 변화

radix 트리 도입으로 만료 시간 정보를 효율적으로 활용해 25% 숨겨진 키 문제를 해결했다.

- 만료 시간이 가까운 키들을 radix tree 에 힌트로 저장
- 랜덤하게 샘플링하는 대신 만료될 가능성이 높은 키들을 타겟팅
- 새로운 키가 생성될 때마다 radix tree 에 추가되는 것은 아니고, 샘플링해서 나온 키 중 만료 시간이 가까운 키들을 힌트로 저장함

