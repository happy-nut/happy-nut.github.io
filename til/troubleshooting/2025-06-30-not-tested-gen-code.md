---
title: not-tested-gen-code
date: 2025-06-30 13:31:06 +0900
---

## 증상
마이그레이션 배치를 gemini cli로 작성하고, 로컬에서 잘 동작하는지만 본 다음에 배포나가서 실행했음
그런데 unique key violation exception 이 떴음

해당 배치 잡은 이미 존재하는 데이터에 대해서 마이그레이션을 실행하는 것이기 때문에, 해당 exception 이 발생하면 안됨

## 원인

확인해보니까 새로 insert된 데이터와 충돌이 난 것이었음
그런데 admin 용으로 열린 것 외에 data remove 는 하지 않는 것으로 알고 있었음

하지만 이건 사실이 아니었음, 한참동안 헤메다가, 결국 remove 가 대고객에서도 발생하고 있다는 것을 알게 됨
데이터가 로그에 찍힌것과 실제 디비에서 대상 데이터를 조회했더니 달라져서 알게 되었음
추가로, gemini 가 짜준 코드에서 굳이 업데이트가 필요하지 않은 엔티티 까지도 save를 하고 있던 것을 발견함
애초에 대상자에서 빠졌다면 이 문제도 생기지 않았을 것.

### 문제 상황 정리

유저가 쿠폰을 발급한지 24시간이 넘었는데도 사용하지 않으면 다시 긁을 수 있음
이 때, unique key 때문에 기존 발급했던 쿠폰을 삭제함
배치가 돌면서, 삭제된 쿠폰은 업데이트 대상이 아닌데도 굳이 save를 함
같은 key에 대해 insert가 생기면서 violation exception 발생

## KPT

- 코드를 자꾸 가정하고 보는 안좋은 습관이 있음
- 로컬에서 동작하는지 테스트는 했지만, 코드를 제대로 리뷰하지 않았음
- GPT에게 맥락을 전부 전달하지 않고(몰랐으니) 분석을 요청하니 삼천포로 빠지게 되어 오히려 시간을 더 씀
